{% extends "base.html" %}
{% load static %}

{% block title %}Flood Risk Map - Flood Warning System{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0" style="min-height: calc(100vh - 100px);">
        <!-- Left Panel: Controls & Legend -->
        <div class="col-lg-3 bg-white border-end shadow-sm d-none d-lg-block" style="overflow-y: auto; max-height: calc(100vh - 100px); -webkit-overflow-scrolling: touch;">
            <div class="sidebar-scrollable p-3 p-lg-4">
                <h3 class="mb-3 fw-bold" style="font-size: clamp(1.25rem, 3vw, 1.5rem);">
                    Map Controls
                </h3>

                <!-- Live Statistics -->
                <div class="card mb-4 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-3 d-flex align-items-center">
                            Live Statistics
                            <span id="stats-loading" class="spinner-border spinner-border-sm ms-auto d-none" role="status"></span>
                        </h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-center p-2 bg-white rounded shadow-sm">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span style="width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 8px #dc3545;"></span>
                                        <strong id="high-count" class="fs-4 text-danger">-</strong>
                                    </div>
                                    <small class="text-muted">High Risk</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-white rounded shadow-sm">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span style="width: 12px; height: 12px; background-color: #fd7e14; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 8px #fd7e14;"></span>
                                        <strong id="medium-count" class="fs-4 text-warning">-</strong>
                                    </div>
                                    <small class="text-muted">Medium</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-white rounded shadow-sm">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span style="width: 12px; height: 12px; background-color: #28a745; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 8px #28a745;"></span>
                                        <strong id="low-count" class="fs-4 text-success">-</strong>
                                    </div>
                                    <small class="text-muted">Low Risk</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-white rounded shadow-sm">
                                    <strong id="total-count" class="fs-4 text-primary">-</strong>
                                    <small class="text-muted d-block">Total Wards</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 border-top">
                            <small class="text-muted">
                                <span id="last-updated">Last updated: --</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-light border-0">
                        <h6 class="mb-0 fw-bold">Legend</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <div class="marker-glow-high me-3"></div>
                                <div>
                                    <strong>High Risk</strong>
                                    <small class="d-block text-muted">Severe flood threat</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <div class="marker-glow-medium me-3"></div>
                                <div>
                                    <strong>Medium Risk</strong>
                                    <small class="d-block text-muted">Moderate threat</small>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex align-items-center">
                                <div class="marker-glow-low me-3"></div>
                                <div>
                                    <strong>Low Risk</strong>
                                    <small class="d-block text-muted">Minimal threat</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    {% if user.is_authenticated %}
                        <a href="{% url 'submit-report-page' %}" class="btn btn-success btn-lg">Submit Report</a>
                        <a href="{% url 'flood-information' %}" class="btn btn-info btn-lg">Flood History</a>
                        {% if user.role == 'authority' %}
                            <a href="{% url 'authority-dashboard' %}" class="btn btn-warning btn-lg">Admin Panel</a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-primary btn-lg">Login to Report</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="col-lg-9 col-12 p-0 position-relative">
            <button class="btn btn-primary d-lg-none position-absolute m-2 shadow" style="z-index: 1000; top: 0; left: 0;" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileControls">
                Menu
            </button>

            <div id="map" style="width: 100%; height: calc(100vh - 100px); position: relative; background: #e3f2fd;">
                <div id="map-loading" class="position-absolute top-50 start-50 translate-middle text-center" style="z-index: 999;">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted fw-bold">Loading flood risk data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileControls">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold">Map Controls</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="card mb-4 bg-light border-0">
            <div class="card-body">
                <h6 class="fw-bold mb-3">Live Statistics</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-danger">High Risk</span>
                    <strong id="high-count-mobile">-</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-warning">Medium Risk</span>
                    <strong id="medium-count-mobile">-</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-success">Low Risk</span>
                    <strong id="low-count-mobile">-</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Total Wards</span>
                    <strong id="total-count-mobile">-</strong>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2">
            {% if user.is_authenticated %}
                <a href="{% url 'submit-report-page' %}" class="btn btn-success">Submit Report</a>
                <a href="{% url 'flood-information' %}" class="btn btn-info">Flood History</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
            {% endif %}
        </div>
    </div>
</div>

<style>
.marker-glow-high { width: 28px; height: 28px; background-color: #dc3545; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px rgba(220, 53, 69, 0.8); animation: pulse-high 2s infinite; flex-shrink: 0; }
.marker-glow-medium { width: 28px; height: 28px; background-color: #fd7e14; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px rgba(253, 126, 20, 0.8); animation: pulse-medium 2s infinite; flex-shrink: 0; }
.marker-glow-low { width: 28px; height: 28px; background-color: #28a745; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); flex-shrink: 0; }
@keyframes pulse-high { 0%, 100% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.8); } 50% { box-shadow: 0 0 25px rgba(220, 53, 69, 1); } }
@keyframes pulse-medium { 0%, 100% { box-shadow: 0 0 15px rgba(253, 126, 20, 0.8); } 50% { box-shadow: 0 0 25px rgba(253, 126, 20, 1); } }
.leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
.leaflet-popup-content { margin: 0; min-width: 280px; }
.ward-popup { padding: 15px; }
.ward-popup h5 { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef; }
.ward-popup .risk-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
.ward-popup .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f1f1; }
.ward-popup .stat-row:last-child { border-bottom: none; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function() {
    'use strict';

    var map, wardData = [], historicalData = {};
    var markersLayer;

    var riskColors = { 'High': '#dc3545', 'Medium': '#fd7e14', 'Low': '#28a745' };

    function getRiskColor(risk) {
        return riskColors[risk] || '#6c757d';
    }

    function createPopupContent(ward, hist) {
        var riskLevel = ward.properties.current_risk_level || 'Low';
        var color = getRiskColor(riskLevel);
        hist = hist || {};
        
        return '<div class="ward-popup">' +
            '<h5 class="fw-bold mb-2">' + ward.properties.name + '</h5>' +
            '<div class="mb-3"><span class="risk-badge" style="background-color: ' + color + '; color: white;">' + riskLevel + ' Risk</span></div>' +
            '<div class="mb-3">' +
                '<small class="text-muted fw-bold">CURRENT STATUS</small>' +
                '<div class="stat-row"><span>Risk Level</span><strong style="color: ' + color + '">' + riskLevel + '</strong></div>' +
                '<div class="stat-row"><span>Flood Probability</span><strong>' + (hist.probability || '--') + '%</strong></div>' +
            '</div>' +
            '<div class="mb-3">' +
                '<small class="text-muted fw-bold">HISTORICAL DATA</small>' +
                '<div class="stat-row"><span>Total Flood Events</span><strong>' + (hist.flood_count || 0) + '</strong></div>' +
                '<div class="stat-row"><span>Avg. Rainfall</span><strong>' + (hist.avg_rainfall || '--') + ' mm</strong></div>' +
                '<div class="stat-row"><span>Vulnerability Index</span><strong>' + (hist.vulnerability || '--') + '/100</strong></div>' +
            '</div>' +
            '<a href="/ward/' + ward.properties.id + '/flood-history/" class="btn btn-sm btn-outline-primary w-100">View Full History</a>' +
        '</div>';
    }

    function updateStatistics() {
        var statsLoading = document.getElementById('stats-loading');
        statsLoading.classList.remove('d-none');

        setTimeout(function() {
            var stats = { high: 0, medium: 0, low: 0 };
            wardData.forEach(function(w) {
                var level = (w.properties.current_risk_level || 'Low').toLowerCase();
                stats[level] = (stats[level] || 0) + 1;
            });

            document.getElementById('high-count').textContent = stats.high;
            document.getElementById('medium-count').textContent = stats.medium;
            document.getElementById('low-count').textContent = stats.low;
            document.getElementById('total-count').textContent = wardData.length;
            document.getElementById('high-count-mobile').textContent = stats.high;
            document.getElementById('medium-count-mobile').textContent = stats.medium;
            document.getElementById('low-count-mobile').textContent = stats.low;
            document.getElementById('total-count-mobile').textContent = wardData.length;

            var now = new Date();
            document.getElementById('last-updated').textContent = 'Last updated: ' + now.toLocaleTimeString();
            statsLoading.classList.add('d-none');
        }, 300);
    }

    function generateFallbackData() {
        var data = {};
        wardData.forEach(function(ward) {
            var risk = ward.properties.current_risk_level || 'Low';
            data[ward.properties.id] = {
                probability: risk === 'High' ? 75 : risk === 'Medium' ? 50 : 25,
                flood_count: risk === 'High' ? 8 : risk === 'Medium' ? 4 : 1,
                avg_rainfall: risk === 'High' ? 120 : risk === 'Medium' ? 80 : 40,
                vulnerability: risk === 'High' ? 80 : risk === 'Medium' ? 50 : 20
            };
        });
        return data;
    }

    function renderMarkers() {
        markersLayer.clearLayers();

        wardData.forEach(function(ward) {
            var geom = ward.geometry;
            if (geom.type === 'Point') {
                var latlng = [geom.coordinates[1], geom.coordinates[0]];
                var riskLevel = ward.properties.current_risk_level || 'Low';
                var color = getRiskColor(riskLevel);
                var hist = historicalData[ward.properties.id] || {};

                var marker = L.circleMarker(latlng, {
                    radius: riskLevel === 'High' ? 12 : 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                });

                marker.bindPopup(createPopupContent(ward, hist), { maxWidth: 320 });

                marker.on('mouseover', function() {
                    this.setStyle({ radius: 15, weight: 4 });
                    this.openPopup();
                });
                marker.on('mouseout', function() {
                    this.setStyle({ radius: riskLevel === 'High' ? 12 : 10, weight: 3 });
                });

                markersLayer.addLayer(marker);

                var label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: '',
                        html: '<div style="background:white;border:2px solid ' + color + ';border-radius:6px;padding:3px 8px;font-size:10px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.2);">' + ward.properties.name + '</div>',
                        iconSize: null,
                        iconAnchor: [50, -10]
                    })
                });
                label.bindPopup(createPopupContent(ward, hist), { maxWidth: 320 });
                markersLayer.addLayer(label);
            }
        });
    }

    function initializeMap() {
        map = L.map('map', {
            zoomControl: true,
            preferCanvas: true
        }).setView([-1.286389, 36.817223], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
            minZoom: 10
        }).addTo(map);

        markersLayer = L.featureGroup().addTo(map);

        fetch('/api/ward-data/')
            .then(function(response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.json();
            })
            .then(function(data) {
                wardData = data.features || [];
                
                return fetch('/api/historical-flood-data/')
                    .then(function(resp) {
                        if (!resp.ok) return generateFallbackData();
                        return resp.json();
                    })
                    .catch(function() {
                        return generateFallbackData();
                    });
            })
            .then(function(histData) {
                historicalData = histData || generateFallbackData();
                
                document.getElementById('map-loading').style.display = 'none';

                updateStatistics();
                renderMarkers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                document.getElementById('map-loading').innerHTML = 
                    '<div class="alert alert-danger">Error loading map data. Please refresh.</div>';
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();

        var resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (map) map.invalidateSize();
            }, 250);
        });
    });
})();
</script>
{% endblock %}